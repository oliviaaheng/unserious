---
import Layout from "../layouts/Layout.astro";

const googleClientId = import.meta.env.PUBLIC_GOOGLE_CLIENT_ID;
---

<Layout public>
  <Fragment slot="head">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600&family=Space+Grotesk:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </Fragment>

  <main class="flex flex-1 items-center justify-center px-5 pb-14 pt-10 sm:px-8">
    <div class="mx-auto flex w-full max-w-md flex-col gap-8">
      <header class="flex flex-col items-center gap-3 text-center">
        <p class="text-xs font-semibold uppercase tracking-[0.3em] text-[#7f6b5c]">
          Welcome Back
        </p>
        <h1 class="font-['Fraunces'] text-3xl sm:text-4xl lg:text-5xl">
          Sign in
        </h1>
        <p class="text-base text-[#5e4b41]">
          Continue with your Google account to pick up where you left off.
        </p>
      </header>

      <section class="flex flex-col items-center gap-6 overflow-hidden rounded-3xl border border-white/60 bg-white/80 p-8 shadow-[0_30px_80px_-50px_rgba(53,36,24,0.7)] backdrop-blur">
        <div id="g_id_onload"
          data-client_id={googleClientId}
          data-callback="handleGoogleLogin"
          data-auto_prompt="false">
        </div>
        <div class="g_id_signin"
          data-type="standard"
          data-shape="pill"
          data-theme="outline"
          data-text="signin_with"
          data-size="large"
          data-logo_alignment="left"
          data-width="320">
        </div>
      </section>
    </div>
  </main>

  <script>
    import { setUser, getUser, decodeJwtPayload, type AuthUser } from "../scripts/auth";

    // If already logged in, redirect away
    if (getUser()) {
      window.location.href = "/home";
    }

    // Google callback must be on window for GSI
    (window as any).handleGoogleLogin = (response: any) => {
      const payload = decodeJwtPayload(response.credential) as any;
      const user: AuthUser = {
        name: payload.name,
        email: payload.email,
        picture: payload.picture,
        token: response.credential,
      };
      setUser(user);
      window.location.href = "/home";
    };
  </script>
</Layout>
